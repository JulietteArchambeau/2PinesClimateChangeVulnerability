###################
# Shiny app script
###################


# Required libraries
library(shiny)
library(reshape2)
library(tidyverse)


df <- readRDS("subdf.rds") 


ui <- fluidPage(
  titlePanel("Selected climatic variables at the location of the populations"),
  sidebarLayout(
    sidebarPanel(
      width = 2,
      selectInput("timeslice_input", "Time slice:", choices = unique(df$timeslice), selected = "1980-2000"),
      selectInput("em_input", "Ensemble Member:", choices = unique(df$ensemble_member), selected = "01"),
      selectInput("rcp_input", "RCP scenario:", choices = unique(df$rcp_scenario), selected = "RCP2.6")),
    mainPanel(
      width = 5,
      div(style = "margin-top: 20px;",
      plotOutput("correlation_plot",height = "600px",width = "700px"))
      )
    )
  )



server <- function(input, output) {
  output$correlation_plot <- renderPlot({
    
    subcor <- df %>% 
      dplyr::filter(ensemble_member == input$em_input & rcp_scenario == input$rcp_input & timeslice == input$timeslice_input) %>% 
      dplyr::select(PopulationCode, clim_var_avg, value) %>% 
      pivot_wider(values_from = value, names_from = clim_var_avg) %>% 
      dplyr::select(-PopulationCode) %>% 
      cor()
    
    
    # Order variables alphabetically
    subcor <- subcor[order(rownames(subcor)), order(colnames(subcor))]
    
    # Melt the correlation matrix into a long format
    subcor <- melt(subcor)
    
    # Convert Var1 and Var2 to factors with levels ordered alphabetically
    subcor$Var1 <- factor(subcor$Var1, levels = unique(subcor$Var1))
    subcor$Var2 <- factor(subcor$Var2, levels = unique(subcor$Var2))
    
    # Get numeric indices of Var1 and Var2
    index_Var1 <- as.numeric(subcor$Var1)
    index_Var2 <- as.numeric(subcor$Var2)
    
    # Filter data to include only upper part of the diagonal
    upper_part <- subset(subcor, index_Var1 > index_Var2)
    
    # Plot
    ggplot(upper_part, aes(Var1, Var2, fill = value)) +
      geom_tile() +
      scale_fill_gradient2(low = "#BB4444", mid = "#FFFFFF", high = "#4477AA", midpoint = 0, limits = c(-1, 1), name="Correlation") +
      geom_text(aes(label = round(value, 2)), color = "black", size = 6) +
      theme_minimal() +
      theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 15),
            axis.text.y = element_text(size = 15),
            legend.title = element_text(size = 15),
            legend.text = element_text(size = 12)) +
      labs(x = NULL, y = NULL)
  })
}

shinyApp(ui, server)
