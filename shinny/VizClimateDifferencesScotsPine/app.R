###################
# Shiny app script
###################

# Visualizing climate differences between current and future climates in Scots pine populations

# Required libraries
library(shiny)
library(mathjaxr)
library(tidyverse)
library(magrittr)
library(reshape2)
library(sf)
library(raster)
library(ncdf4)
library(ggrepel)
library(rnaturalearth)
library(rnaturalearthhires)
world <- ne_countries(scale = "large", returnclass = "sf")

# Figure options
axis_text_size <- 14
axis_title_size <- 17
legend_text_size <- 14 
legend_title_size <- 17
bg_color <- "gray44"


# Chess-scape climatic data (timeslices)
df <- readRDS("climdf.rds") %>% pivot_longer(names_to = "time_averages", values_to = "value",cols=contains(c("month","seas","annual")))

# Calculate relative climatic differences
climdiff <- df %>% 
  pivot_wider(names_from = timeslice, values_from = value, names_prefix = "timeslice_") %>% 
  mutate(abs_diff = timeslice_2060_2080 - timeslice_1980_2000,
         rel_diff = (timeslice_2060_2080 - timeslice_1980_2000) * 100 / timeslice_2060_2080)

# Read the variable info table
variable_info <- read_csv("variable_info.csv")

# Common garden coordinates
site_coord <- read_csv("site_coordinates.csv",show_col_types = FALSE)


#########
#  UI
#########
ui <- fluidPage(
  titlePanel("Differences between current and future climates at the location of the populations"),
  sidebarLayout(
    sidebarPanel(
      width = 2, # Adjust the width here
      selectInput("time_averages", "Time average:", choices = unique(df$time_averages)),
      selectInput("clim_var", "Climatic variable:", choices = unique(df$clim_var)),
      selectInput("ensemble_member", "Ensemble member:", choices = unique(df$ensemble_member)),
      selectInput("rcp_scenario", "RCP scenario:", choices = unique(df$rcp_scenario)),
      selectInput("time_slice", "Time slice:", choices = unique(df$timeslice))
    ),
    mainPanel(
      tabsetPanel(
        tabPanel("About this app",
                 htmlOutput("about_app_text")),
        tabPanel("Climatic variables",
                 tableOutput("variable_info_table")),
        tabPanel("Map of population climates",
                 plotOutput("map_plot", height = "700px")),
        tabPanel("Correlations",
                 plotOutput("correlation_plot", height = "800px",width = "1350px")),
        tabPanel("Population climates across time slices", 
                 div(style = "margin-top: 20px;",
                     htmlOutput("timeslice_plot_text")),
                 div(style = "margin-top: 20px;",
                 plotOutput("timeslice_plot"))),
        tabPanel("Relative climatic differences",
                 div(style = "margin-top: 20px;",
                     withMathJax(uiOutput("climatic_diff_text"))),
                 div(style = "margin-top: 20px;",
                     plotOutput("relative_climatic_differences_plot")))
      )
    )
  )
)


########
# Server
########
server <- function(input, output) {

  
# About this app
################
  output$about_app_text <- renderUI({
    HTML(
      "</br>
      <p>This application aims to explore the differences between current and future climates at the location of 21 native Scottish Scots pine populations (<i>Pinus sylvestris</i>).</p>
       <p>We use the <b>CHESS-SCAPE data</b>, a 1-km resolution dataset containing <b>11 near-surface meteorological variables</b> over the United Kingdom (Robinson et al. 2023), freely available from the NERC EDS Centre for Environmental Data Analysis: <a href='https://doi.org/10.5285/8194b416cbee482b89e0dfbe17c5786c'>https://doi.org/10.5285/8194b416cbee482b89e0dfbe17c5786c</a>.</p>
       <p>See the panel 'Climatic variables' for details on the 11 climatic variables.</p>
       <p><b>Three time slices</b> (20-year mean monthly climatologies) are available: the 1980-2000 time slice, which is used as the reference time period, and the 2030-2050 and 2060-2080 time slices, which are used for future climates.</p>
       <p>For each time slice, <b>monthly, seasonnal or annual time averages</b> are available.</p>
       <p>The CHESS-SCAPE data is based on the 12-km resolution UKCP18 RCM-PPE (Met Office Hadley Centre, 2019), a perturbed parameter ensemble containing 12 members. <b>Four ensemble members</b> are available in CHESS-SCAPE: EM01, which is the default model configuration, and three other members (EM04, EM06, EM15), chosen to span the range of futures in the RCM-PPE.</p>
       <p><b>Two RCP scenarios</b> are available: RCP2.6 and RCP8.5. The RCP scenarios are available with or without bias correction. Note that the daily near-surface air temperature range (<i>dtr</i>) and the surface air pressure (<i>psurf</i>) are not available with bias correction.</p>
       </br>
       </br>
       <p><font color='#527DF3'> References </font></p>
       <p>Met Office Hadley Centre: UKCP18 Regional Projections on a 12-km grid over the UK for 1980–2080, <a href='https://catalogue.ceda.ac.uk/uuid/589211abeb844070a95d061c8cc7f604'>https://catalogue.ceda.ac.uk/uuid/589211abeb844070a95d061c8cc7f604</a>, 2019.</p>
       <p>Robinson, E. L., Huntingford, C., Semeena, V. S., and Bullock, J. M.: CHESS-SCAPE: high-resolution future projections of multiple climate scenarios for the United Kingdom derived from downscaled United Kingdom Climate Projections 2018 regional climate model output, Earth Syst. Sci. Data, 15, 5371–5401,
       <a href='https://doi.org/10.5194/essd-15-5371-2023'>https://doi.org/10.5194/essd-15-5371-2023</a>, 2023.</p>"
    )
  })
  
  
# CHESS-SCAPE climatic variables
################################

  output$variable_info_table <- renderTable({
    variable_info
  })
  

# Correlations
##############
  
  output$correlation_plot <- renderPlot({
    
    # Compute correlation matrix
    corclim <- climdiff %>%
      filter(ensemble_member == input$ensemble_member,
             rcp_scenario == input$rcp_scenario,
             time_averages %in% c("seas_djf","seas_mam","seas_jja","seas_son","annual")) %>% 
      mutate(climvar_timeavg = paste0(clim_var,"_",time_averages)) %>% 
      dplyr::select(PopulationCode,paste0("timeslice_",input$time_slice), climvar_timeavg) %>% 
      pivot_wider(names_from = climvar_timeavg, values_from = paste0("timeslice_",input$time_slice)) %>% 
      dplyr::select(-PopulationCode) %>% 
      cor()
    
    # Order variables alphabetically
    corclim <- corclim[order(rownames(corclim)), order(colnames(corclim))]
    
    # Melt the correlation matrix into a long format
    cor_data <- melt(corclim)
    
    # Plot
    ggplot(cor_data, aes(Var1, Var2, fill = value)) +
      geom_tile(color = "white") +
      scale_fill_gradient2(low = "#BB4444", mid = "#FFFFFF", high = "#4477AA", midpoint = 0, limits = c(-1, 1), name="Correlation") +
      geom_text(aes(label = round(value, 2)), color = "black", size = 3) +
      theme_minimal() +
      theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
      labs(x = NULL, y = NULL)
    
  })

# Map of population climates
############################

output$map_plot <- renderPlot({
    mapdf <- df %>% 
      filter(time_averages == input$time_averages &
               clim_var == input$clim_var &
               ensemble_member == input$ensemble_member &
               rcp_scenario == input$rcp_scenario,
             timeslice == input$time_slice) %>% 
      arrange(PopulationCode)
    
    point_size=4
    x_limits = c(-7, -1)
    y_limits = c(55.5, 59)
    legend_position = c(0.85,0.8)
    legend_box_background = "gray80"
    
    p <- ggplot() + 
      geom_sf(data = world, fill="gray98") + 
      theme_bw() +
      scale_x_continuous(limits = x_limits) +
      scale_y_continuous(limits = y_limits) + 
      geom_point(data=mapdf, aes(x=Longitude,y=Latitude,color=value), size=point_size) + 
      geom_point(data=site_coord, aes(x=Longitude,y=Latitude), 
                 size=5, color="black", shape=8) +
      
      xlab("") + ylab("") +
      theme(legend.position = legend_position,
            legend.box.background = element_rect(colour = legend_box_background))  +
      scale_color_gradientn(name = "Climatic value", colours = rev(rainbow(5)), limits=NULL)
    
    coords <- site_coord %>% 
      mutate(ID = paste0(FieldSite, " (", FieldSiteName,")")) %>% 
      dplyr::select(ID, contains("ude"))
    
    coords <- mapdf %>% 
      mutate(ID = PopulationCode) %>% 
      dplyr::select(ID, contains("ude")) %>% 
      bind_rows(coords) %>%  
      st_as_sf(coords = c("Longitude","Latitude"), crs =4326)
    
    nudges <- data.frame(ID=coords$ID,
                         nudge_x = rep(0.1,nrow(coords)),
                         nudge_y = rep(0.1, nrow(coords)))
    
    nudges[nudges$ID=="FS (Yair)",2:3] <- c(0,0.15)  
    nudges[nudges$ID=="FE (Glensaugh)",2:3] <- c(0.2,-0.15)  
    nudges[nudges$ID=="FW (Inverewe)",2:3] <- c(-0.25,0.15)  
    
    nudges[nudges$ID=="CC",2:3] <- c(-0.02,-0.09)  
    nudges[nudges$ID=="CG",2:3] <- c(-0.06,0.09)
    nudges[nudges$ID=="GL",2:3] <- c(0.06,0.09)
    
    nudges[nudges$ID=="CR",2:3] <- c(-0.06,0.09)
    nudges[nudges$ID=="MG",2:3] <- c(0.06,-0.09)
    nudges[nudges$ID=="BW",2:3] <- c(0.06,0.09)
    
    nudges[nudges$ID=="GT",2:3] <- c(0.06,0.09)
    nudges[nudges$ID=="BB",2:3] <- c(0.06,-0.09)
    nudges[nudges$ID=="AC",2:3] <- c(0.06,0.09)
    nudges[nudges$ID=="GD",2:3] <- c(-0.1,-0.08)
    nudges[nudges$ID=="RM",2:3] <- c(-0.23,0)
    nudges[nudges$ID=="AB",2:3] <- c(0.06,0.09)
    
    nudges[nudges$ID=="GA",2:3] <- c(0.15,-0.07)
    nudges[nudges$ID=="GC",2:3] <- c(0.06,0.09)
    
    nudges[nudges$ID=="SD",2:3] <- c(-0.15,-0.07)
    nudges[nudges$ID=="LC",2:3] <- c(0.07,-0.08)
    nudges[nudges$ID=="BE",2:3] <- c(0.12,0.08)
    
    
    nudges[nudges$ID=="AM",2:3] <- c(0.1,-0.07)
    nudges[nudges$ID=="RD",2:3] <- c(-0.03,-0.08)
    nudges[nudges$ID=="SO",2:3] <- c(0.08,0.08)
    nudges[nudges$ID=="GE",2:3] <- c(-0.12,0.08)
    
    
    p + geom_sf_text(data = coords, aes(label = ID),
                     nudge_x = nudges$nudge_x,
                     nudge_y = nudges$nudge_y)
    
  })
  

 # Comparing population climates across time slices
 ##################################################
  
  output$timeslice_plot_text <- renderUI({
    HTML(
    "<p>This graph shows climatic differences across time slices (1980-2000, 2030-2050 and 2060-2080) for each population.</p>
     <p>Please select the time average (monthly, seasonal or annual), the climatic variable, the ensemble member and the RCP scenario from the side bar panel.</p>")
  })
  
  output$timeslice_plot <- renderPlot({
    filtered_data <- df %>%
      filter(time_averages == input$time_averages &
               clim_var == input$clim_var &
               ensemble_member == input$ensemble_member &
               rcp_scenario == input$rcp_scenario)
    
    # Filter the data based on selected clim_var and calculate y-axis limits
    filtered_clim_var_data <- df %>%
      filter(clim_var == input$clim_var)
    
    y_limits <- range(filtered_clim_var_data$value)
    
    ggplot(filtered_data, aes(x = PopulationCode, y = value, group = timeslice, color = timeslice)) +
      geom_point(size=4) +
      labs(x = "Populations", y = "Climatic Value", #title = "Climatic Differences Across Time Periods",
           color = "Time slices") +  # Changed legend title
      scale_color_manual(values = c("1980_2000" = "darkgoldenrod1", "2030_2050" = "chocolate1", "2060_2080" = "brown4")) +  # Changed colors
      theme_bw() +
      theme(axis.text = element_text(size=axis_text_size),
            axis.title = element_text(size=axis_title_size),
            legend.text = element_text(size=legend_text_size),
            legend.title = element_text(size=legend_title_size)) +
      ylim(y_limits)  # Set y-axis limits
  })
  
# Relative climatic differences
###############################
  
  output$climatic_diff_text <- renderUI({
    withMathJax(helpText(
      "The graph below shows the relative difference (\\(RD\\)) in climatic values between the periods of 1980-2000 and 2060-2080, calculated as follows:

    $$RD = \\frac{(x_{1980-2000} - x_{2060-2080}) \\times 100}{x_{1980-2000}}$$

    Please select the time averages from the side bar panel."))
  })
  
  # Render relative climatic differences plot
  output$relative_climatic_differences_plot <- renderPlot({
    filtered_data <- climdiff %>%
      filter(time_averages == input$time_averages)
    
    
    ggplot(filtered_data, aes(x = clim_var, y = rel_diff, color = rcp_scenario)) +
      geom_hline(yintercept = 0, color = bg_color) +
      geom_point(alpha = 0.4,position = position_jitterdodge(jitter.width = 0.1, dodge.width = 0.75), size = 3) +
      labs(x = "Climatic variables", y = "Relative Climatic Difference (%)", color = "RCP scenario") +
      theme_bw() +
      theme(axis.text = element_text(size = axis_text_size),
            axis.title = element_text(size = axis_title_size),
            legend.text = element_text(size = legend_text_size),
            legend.title = element_text(size = legend_title_size))
    
  })
  
}

######################
# Run the application
######################
shinyApp(ui = ui, server = server)
