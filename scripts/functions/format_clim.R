# Function to format climate data (mean-center the climatic variables and get datasets with climatic variables in columns)
format_clim <- function(climdf, EM, RCP, fut_timeslice, clim_var_avg_selected){
  
  # Dataset with the climatic variables of the reference period (not scaled)
  climdf_ref <- climdf %>% 
    filter(ensemble_member == EM & rcp_scenario == RCP & timeslice == "1980-2000" & clim_var_avg %in% clim_var_avg_selected) %>% 
    dplyr::select(-clim_var, -time_averages) %>% 
    pivot_wider(names_from = clim_var_avg, values_from = value)
  
  # Extract scaling parameters, i.e. mean and variance
  scale_params <- lapply(clim_var_avg_selected, function(x){
    
    vec_var <- climdf_ref[,x] %>% pull()
    
    list(mean = mean(vec_var),
         sd = sd(vec_var))
    
  }) %>% setNames(clim_var_avg_selected)
  
  
  # Mean-center the climatic variables across the reference period
  climdf_ref_scaled <- climdf_ref %>%
    dplyr::mutate(across(any_of(clim_var_avg_selected), ~ (. - mean(.)) / sd(.)))
  
  # Dataset with the climatic variables across the future period (not scaled)
  climdf_fut <- climdf %>% 
    filter(ensemble_member == EM & rcp_scenario == RCP & timeslice == fut_timeslice & clim_var_avg %in% clim_var_avg_selected) %>% 
    dplyr::select(-clim_var, -time_averages) %>% 
    pivot_wider(names_from = clim_var_avg, values_from = value)
  
  # Mean-center the climatic variables across the future period
  climdf_fut_scaled <- climdf_fut
  for(i in clim_var_avg_selected){
    climdf_fut_scaled[,i] <- (climdf_fut_scaled[,i] - scale_params[[i]]$mean) / scale_params[[i]]$sd
  }
  
  list(climdf_ref=climdf_ref, 
       climdf_fut=climdf_fut, 
       climdf_ref_scaled=climdf_ref_scaled, 
       climdf_fut_scaled=climdf_fut_scaled, 
       scale_params=scale_params)
}