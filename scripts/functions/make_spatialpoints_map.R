# Function to make maps with different values at the location of the populations
library(sf)
library(ggrepel)

library(rnaturalearth)
world <- ne_countries(scale = "large", returnclass = "sf")

make_spatialpoints_map <- function(df,
                                   var,
                                   pop_coord=NULL,
                                   site_coord=NULL,
                                   point_size=4, 
                                   x_limits = c(-7, -1),
                                   y_limits = c(55.5, 59),
                                   labels=TRUE,
                                   legend_position = c(0.85,0.8),
                                   legend_box_background = "gray80",# "gray80"
                                   var_limits=NULL,
                                   ggtitle=NULL){

if(is.null(pop_coord)) pop_coord <-  read_csv(here("data/ScotsPine/population_coordinates.csv"),show_col_types = FALSE)  
if(is.null(site_coord)) site_coord <- read_csv(here("data/ScotsPine/site_coordinates.csv"),show_col_types = FALSE)

df <- df %>% arrange(PopulationCode)

if(identical(df$PopulationCode,pop_coord$PopulationCode)==F){
  stop("Different populations are provided in 'df' and 'pop_coord'.")}
  
df <-  df %>% 
  dplyr::select(PopulationCode,any_of(var)) %>% 
  set_colnames(c("PopulationCode","variable")) %>% 
  inner_join(pop_coord, by = "PopulationCode")


p <- ggplot() + 
  geom_sf(data = world, fill="gray98") + 
  theme_bw() +
  scale_x_continuous(limits = x_limits) +
  scale_y_continuous(limits = y_limits) + 
  geom_point(data=df, aes(x=Longitude,y=Latitude,color=variable), size=point_size) + 
  geom_point(data=site_coord, aes(x=Longitude,y=Latitude), 
             size=5, color="black", shape=8) +
  
  xlab("") + ylab("") +
  ggtitle(ggtitle) +
  theme(legend.position = legend_position,
        legend.box.background = element_rect(colour = legend_box_background))  +
  scale_color_gradientn(name = var, colours = rev(rainbow(5)), limits=var_limits)
  
if(labels==TRUE){
  coords <- site_coord %>% 
    mutate(ID = paste0(FieldSite, " (", FieldSiteName,")")) %>% 
    dplyr::select(ID, contains("ude"))
  
  coords <- df %>% 
    mutate(ID = PopulationCode) %>% 
    dplyr::select(ID, contains("ude")) %>% 
    bind_rows(coords) %>%  
    st_as_sf(coords = c("Longitude","Latitude"), crs =4326)
  
  nudges <- data.frame(ID=coords$ID,
                       nudge_x = rep(0.1,nrow(coords)),
                       nudge_y = rep(0.1, nrow(coords)))
  
  nudges[nudges$ID=="FS (Yair)",2:3] <- c(0,0.15)  
  nudges[nudges$ID=="FE (Glensaugh)",2:3] <- c(0.2,-0.15)  
  nudges[nudges$ID=="FW (Inverewe)",2:3] <- c(-0.25,0.15)  
  
  nudges[nudges$ID=="CC",2:3] <- c(-0.02,-0.09)  
  nudges[nudges$ID=="CG",2:3] <- c(-0.06,0.09)
  nudges[nudges$ID=="GL",2:3] <- c(0.06,0.09)
  
  nudges[nudges$ID=="CR",2:3] <- c(-0.06,0.09)
  nudges[nudges$ID=="MG",2:3] <- c(0.06,-0.09)
  nudges[nudges$ID=="BW",2:3] <- c(0.06,0.09)
  
  nudges[nudges$ID=="GT",2:3] <- c(0.06,0.09)
  nudges[nudges$ID=="BB",2:3] <- c(0.06,-0.09)
  nudges[nudges$ID=="AC",2:3] <- c(0.06,0.09)
  nudges[nudges$ID=="GD",2:3] <- c(-0.1,-0.08)
  nudges[nudges$ID=="RM",2:3] <- c(-0.23,0)
  nudges[nudges$ID=="AB",2:3] <- c(0.06,0.09)
  
  nudges[nudges$ID=="GA",2:3] <- c(0.15,-0.07)
  nudges[nudges$ID=="GC",2:3] <- c(0.06,0.09)
  
  nudges[nudges$ID=="SD",2:3] <- c(-0.15,-0.07)
  nudges[nudges$ID=="LC",2:3] <- c(0.07,-0.08)
  nudges[nudges$ID=="BE",2:3] <- c(0.12,0.08)
  
  
  nudges[nudges$ID=="AM",2:3] <- c(0.1,-0.07)
  nudges[nudges$ID=="RD",2:3] <- c(-0.03,-0.08)
  nudges[nudges$ID=="SO",2:3] <- c(0.08,0.08)
  nudges[nudges$ID=="GE",2:3] <- c(-0.12,0.08)
  
  
p <- p + geom_sf_text(data = coords, aes(label = ID),
               nudge_x = nudges$nudge_x,
               nudge_y = nudges$nudge_y)
    
}


  return(p)
}
