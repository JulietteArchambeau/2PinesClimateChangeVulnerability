data {
  int<lower=1> n;                                                               // Number of observations
  vector[n] y;                                                                  // Response variable
  int<lower=0> n_site;                                                          // Number of sites
  int<lower=0> n_bloc;                                                          // Number of blocks
  int<lower=0> n_pop;                                                           // Number of populations
  int<lower=0> n_fam;                                                           // Number of families
  int<lower=0> n_nurs;                                                          // Number of nurseries
  int<lower=0> n_site_fam;                                                      // Number of sites x families
  int<lower=0> n_site_nurs;                                                     // Number of sites x nurseries
  int<lower=0, upper=n_site> site[n];                                           // Sites
  int<lower=0, upper=n_bloc> bloc[n];                                           // Blocks
  int<lower=0, upper=n_pop> pop[n];                                             // Populations
  int<lower=0, upper=n_fam> fam[n];                                             // Families
  int<lower=0, upper=n_nurs> nurs[n];                                           // Nurseries
  int<lower=0, upper=n_site_fam> site_fam[n];                                   // Sites * families
  int<lower=0, upper=n_site_nurs> site_nurs[n];                                 // Sites * nurseries
}


parameters {
  real beta0; // global intercept
  simplex[8] pi;
  real<lower = 0> sigma_tot;
  
  vector[n_site] z_site;
  vector[n_bloc] z_block;
  vector[n_pop] z_pop;
  vector[n_fam] z_fam;
  vector[n_nurs] z_nurs;
  vector[n_site_fam] z_site_fam;
  vector[n_site_nurs] z_site_nurs;
  
}


transformed parameters {
  real R_squared;
  
  real<lower = 0>  sigma_r;
  real<lower = 0>  sigma_site;
  real<lower = 0>  sigma_block;
  real<lower = 0>  sigma_pop;
  real<lower = 0>  sigma_fam;
  real<lower = 0>  sigma_nurs;
  real<lower = 0>  sigma_site_fam;
  real<lower = 0>  sigma_site_nurs;
  
  vector[n_site] alpha_site;
  vector[n_bloc] alpha_block;
  vector[n_pop] alpha_pop;
  vector[n_fam] alpha_fam;
  vector[n_nurs] alpha_nurs;
  vector[n_site_fam] alpha_site_fam;
  vector[n_site_nurs] alpha_site_nurs;
  
  vector[n] mu; // linear predictor
  
  // variance partitioning with the simplex pi
  sigma_r = sqrt(pi[1]) * sigma_tot;
  sigma_site = sqrt(pi[2]) * sigma_tot;
  sigma_block = sqrt(pi[3]) * sigma_tot;
  sigma_pop = sqrt(pi[4]) * sigma_tot;
  sigma_fam= sqrt(pi[5]) * sigma_tot;
  sigma_nurs= sqrt(pi[6]) * sigma_tot;
  sigma_site_fam= sqrt(pi[7]) * sigma_tot;
  sigma_site_nurs= sqrt(pi[8]) * sigma_tot;
  
  alpha_site = z_site*sigma_site;
  alpha_block = z_block*sigma_block;
  alpha_pop = z_pop*sigma_pop;
  alpha_fam = z_fam*sigma_fam;
  alpha_nurs = z_nurs*sigma_nurs;
  alpha_site_fam = z_site_fam*sigma_site_fam;
  alpha_site_nurs = z_site_nurs*sigma_site_nurs;
  
  
  mu = rep_vector(beta0, n) + 
  alpha_site[site] + 
  alpha_block[bloc] + 
  alpha_pop[pop] + 
  alpha_fam[fam] + 
  alpha_nurs[nurs] + 
  alpha_site_fam[site_fam] + 
  alpha_site_nurs[site_nurs];
  
  R_squared = 1 - variance(y - mu) / variance(y);
}

model{
  //Priors
  beta0 ~ normal(mean(y),20);
  sigma_tot ~ student_t(3, 0.0, 1.0);
  
  z_site ~ std_normal();
  z_block ~ std_normal();
  z_pop ~ std_normal();
  z_fam ~ std_normal();
  z_nurs ~ std_normal();
  z_site_fam ~ std_normal();
  z_site_nurs ~ std_normal();
  
  // Likelihood
  y ~ normal(mu, sigma_r);
}


generated quantities {
  // Variances, narrow-sense heritability and evolvability
  real<lower=0> sigma2_tot;
  real<lower=0> sigma2_r;
  real<lower=0> sigma2_site;
  real<lower=0> sigma2_block;
  real<lower=0> sigma2_pop;
  real<lower=0> sigma2_fam;
  real<lower=0> sigma2_nurs;
  real<lower=0> sigma2_site_fam;
  real<lower=0> sigma2_site_nurs;
  real<lower=0> h2;
  real<lower=0> I;
  
  sigma2_tot = square(sigma_tot);
  sigma2_r = square(sigma_r);
  sigma2_site = square(sigma_site);
  sigma2_block = square(sigma_block);
  sigma2_pop = square(sigma_pop);
  sigma2_fam = square(sigma_fam);
  sigma2_nurs = square(sigma_nurs);
  sigma2_site_fam = square(sigma_site_fam);
  sigma2_site_nurs = square(sigma_site_nurs);
  h2 = (4*sigma2_fam)/(sigma2_r+sigma2_fam);
  I = (4*sigma2_fam)/(mean(y)^2);
  
}

