---
title: "Estimating phenotypic plasticity of Scots pine populations"
author: "Juliette Archambeau"
date: "`r format(Sys.time(), '%d %B, %Y')`"
format: 
  html:
    toc: true
    toc-depth: 4
    code-fold: true
    page-layout: full
embed-resources: true
bibliography: references.bib
editor_options: 
  chunk_output_type: console
---

<style type="text/css">
body {
   font-size: 15px;
}
code.r{
  font-size: 11px;
}
pre {
  font-size: 11px
}

table {
  font-size: 11px
}
</style>

```{r setup, include=F}
knitr::opts_chunk$set(dev.args = list(png = list(type = "cairo")))
knitr::opts_chunk$set(cache=F)
options(width = 300)
library(knitr)      # CRAN v1.26
library(kableExtra) # CRAN v1.1.0
library(tidyverse)
library(here)
library(magrittr)
library(corrplot)
library(readxl)

# my own function for building tables in reports
source(here("scripts/functions/kable_mydf.R"))
source(here("scripts/functions/make_spatialpoints_map.R"))
```

# Introduction

<span style="color: darkgreen;">**Data information**</span>

All info in @beaton2022phenotypic.

Seed from **ten trees** from each of **21 native Scottish *P. sylvestris* populations** were collected in March 2007. Populations were chosen to represent the species native range in Scotland and to include three populations from each of the seven seed zones. 

Trees from the same population can be considered unrelated (see sampling strategy). Seedlings from the same mother tree are described as a family and are assumed to be half-siblings.

After growing in one of three nurseries (NW, NG and NE), trees were transplanted to one of three field sites in 2012: 
  
  - **Yair** in the Scottish Borders (field site in the south of Scotland: **FS**, latitude 55.603625, longitude -2.893025). All trees transplanted to FS were raised in the NG.
  
  - **Glensaugh** (field site in the east of Scotland: **FE**, latitude 56.893567, longitude -2.535736). All but four of the trees transplanted to FE were raised locally in the NE (the remainder were grown in NG).
  
  - **Inverewe** (field site in the west of Scotland: **FW**, latitude 57.775714, longitude -5.597181). FW contains cohorts of trees raised in each of the three nurseries as follows: 290 were grown locally in the NW; 132 were grown in the NG; and 82 were grown in the NE.


At each site, trees were planted in randomised blocks at 3 m x 3 m spacing. There are **four randomised blocks in both FS and FE** and **three in FW**. 

There are **168 families** in total. Each block comprised one individual from each of eight (of the 10 sampled) families per 21 populations (168 trees). 

<span style="color: red;">Although most families (N = 159) were represented at each of the three sites, families with insufficient trees (N = 9) were replaced in one site (FS) with a different family from the same population.</span>

<span style="color: darkgreen;">**Important points for the phenotypic plasticity analyses**</span>

  - strong effect of nurseries on the phenotypes
  
  - potential effects of blocks
  
  - In FS, some families are not the same as in FE and FW.
  
  - FE is the site with the harshest climate (i.e. coldest site with the shortest growing season length) and FW the most beneficial climate, i.e. warmer and wetter and with more growing degree days per year and a much longer season length than the two other sites  [see Table 2 of @beaton2022phenotypic]. 


# Relative distance plasticity index (RDPI)

@valladares2006quantitative proposes to quantify phenotypic plasticity based on phenotypic distances among individuals of a given species (in our study, population) exposed to different environments (in our study, planted in different common gardens), which is summarized in a relative distance plasticity index (RDPI) that allows for statistical comparisons of phenotypic plasticity between species (in our study, populations). 


For a given trait, the relative distance plasticity index $RDPI_p$ for a given population $p$ can be calculated as follows:

$$RDPI_p = \frac{\sum_{n=1}^N{\frac{x_{ij}-x_{i'j'}}{x_{ij}+x_{i'j'}}}}{N}$$

where $N$ is the number of pairwise comparisons among individuals of the same population but from different common gardens. $x_{ij}$ and $x_{i'j'}$ are the phenotypic values of individual $j$ and $j'$ in common gardens $i$ and $i’$, with $ii’$. As such, the phenotypic plasticity of a population for a given trait corresponds to the sum of the relative phenotypic distances for all pairs of individuals of the population grown in different common gardens.

```{r LoadCGdata, eval=T}
data <- read_excel(here("data/Field.xlsx"), na = "NA")
```

We check the number of NAs for height measurements.

```{r CheckNAheightMeasurments}
data %>% dplyr::select(contains("HA")) %>% sapply(function(x) sum(is.na(x)))
```

We calculate the RDPI for height measurments.

```{r CalculateRDPI, eval=F}
pop_codes <- unique(data$PopulationCode) # population codes
site_codes <- unique(data$FieldSite) # field site codes
traits <- data %>% dplyr::select(contains("HA")) %>% colnames() # height measurements
site_comb <- combn(site_codes,2)
calc_rel_dist <- function(x){abs(x[1]-x[2])/(x[1]+x[2])}

rdpi <- lapply(traits, function(trait){

  lapply(pop_codes, function(pop){
  
  subpop <- data %>%
    drop_na(any_of(trait)) %>% 
    dplyr::filter(PopulationCode %in% pop)
  
  n_pop <- nrow(subpop) # nb of individuals in the population

 rel_dist <- lapply(1:dim(site_comb)[[2]], function(nb_comb){
 
    subsite1 <- subpop %>% dplyr::filter(FieldSite %in% site_comb[1,nb_comb])
    subsite2 <- subpop %>% dplyr::filter(FieldSite %in% site_comb[2,nb_comb])
    
    
    lapply(1:nrow(subsite1), function(x) {
      
      
      rbind(subsite1[x,trait],subsite2[,trait]) %>% 
        pull() %>% 
        combn(2, calc_rel_dist) %>% 
        .[1:nrow(subsite2)] %>% 
        as.numeric()
      
      }) %>% unlist()
    
    }) %>% unlist()
 
 N <- length(rel_dist)
 
sum(rel_dist)/N
 
 
 }) %>% 
    setNames(pop_codes) %>% 
    as_tibble() %>% 
    pivot_longer(everything(), names_to = "PopulationCode", values_to = "RDPI") %>% 
    mutate(Trait=trait)
  
  }) %>% bind_rows()

rdpi %>% saveRDS(file=here("outputs/PhenotypicPlasticity/RDPI.rds"))
```

```{r MappingRDPI, fig.height=8,fig.width=8, warning=F, results="hide"}
lapply(c("HA14","HA20"), function(trait){

readRDS(file=here("outputs/PhenotypicPlasticity/RDPI.rds")) %>% 
  filter(Trait == trait) %>% 
  make_spatialpoints_map(var="RDPI",
                         ggtitle=trait)})
```

```{r CorrelationPlotsRDPIheight, fig.height=5,fig.width=5}
readRDS(file=here("outputs/PhenotypicPlasticity/RDPI.rds")) %>% 
  pivot_wider(values_from = RDPI, names_from = Trait) %>% 
  dplyr::select(-PopulationCode) %>% 
  cor() %>% 
  corrplot(method = 'number',
           type = 'lower', diag = FALSE,
           title="Correlation among RDPI for height measurements",
           mar=c(0,0,2,0),
           number.cex=0.9,tl.cex=0.9)
```

However, I see two negative points in this approach:

  - the effect of the nurseries on the phenotypes is not accounted for.
  
  - no measure of uncertainty around RDPI estimates.
  
  
  
# In a Bayesian framework?

Would that be possible to calculate the RDPI with `Stan`?

