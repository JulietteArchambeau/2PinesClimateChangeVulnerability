---
title: "Data information & exploratory analyses"
author: "Juliette Archambeau"
date: last-modified
format: 
  html:
    toc: true
    toc-depth: 4
    code-fold: true
    page-layout: full
embed-resources: true
bibliography: references.bib
editor_options: 
  chunk_output_type: console
---

<style type="text/css">
body {
   font-size: 15px;
}
code.r{
  font-size: 11px;
}
pre {
  font-size: 11px
}

table {
  font-size: 11px
}
</style>

```{r setup, include=F}
knitr::opts_chunk$set(cache=F)
options(width = 300)
library(knitr)      # CRAN v1.26
library(kableExtra) # CRAN v1.1.0
library(tidyverse)
library(here)
library(magrittr)
library(corrplot)
library(readxl)
library(cowplot)

# my own function for building tables in reports
source(here("scripts/functions/kable_mydf.R"))
```

# The data

## Data information

All info in @beatonPhenotypicTraitVariation2022

Seed from **ten trees** from each of **21 native Scottish *P. sylvestris* populations** were collected in March 2007. Populations were chosen to represent the species native range in Scotland and to include three populations from each of the seven seed zones. 

Trees from the same population can be considered unrelated (see sampling strategy). Seedlings from the same mother tree are described as a family and are assumed to be half-siblings.

After growing in one of three nurseries (NW, NG and NE), trees were transplanted to one of three field sites in 2012: 
  
  - **Yair** in the Scottish Borders (field site in the south of Scotland: **FS**, latitude 55.603625, longitude -2.893025). All trees transplanted to FS were raised in the NG.
  
  - **Glensaugh** (field site in the east of Scotland: **FE**, latitude 56.893567, longitude -2.535736). All but four of the trees transplanted to FE were raised locally in the NE (the remainder were grown in NG).
  
  - **Inverewe** (field site in the west of Scotland: **FW**, latitude 57.775714, longitude -5.597181). FW contains cohorts of trees raised in each of the three nurseries as follows: 290 were grown locally in the NW; 132 were grown in the NG; and 82 were grown in the NE.


At each site, trees were planted in randomised blocks at 3 m x 3 m spacing. There are **four randomized blocks in both FS and FE** and **three in FW**. 

There are **168 families** in total. Each block comprised one individual from each of eight (of the 10 sampled) families per 21 populations (168 trees). 

<span style="color: red;">Although most families (N = 159) were represented at each of the three sites, families with insufficient trees (N = 9) were replaced in one site (FS) with a different family from the same population.</span>

<span style="color: darkgreen;">**Important points**</span>

  - potential strong effect of nurseries on the phenotypes
  
  - potential effects of blocks
  
  - In FS, some families are not the same as in FE and FW.
  
  - FE is the site with the harshest climate (i.e. coldest site with the shortest growing season length) and FW the most beneficial climate, i.e. warmer and wetter and with more growing degree days per year and a much longer season length than the two other sites  [see Table 2 of @beatonPhenotypicTraitVariation2022]. 



## Data loading

> Fiel site data

```{r LoadCGdata, eval=T}
data <- read_excel(here("data/ScotsPine/Field.xlsx"), na = "NA")
```

> Nursery data


```{r LoadNurseryDataPerry2022, message=F}
# Dataset in Beaton et al. (2022)
nursery_data <- read_delim(here("data/ScotsPine/nurserytraits.txt"), show_col_types = FALSE) %>% 
  dplyr::select(PopulationCode, Family,Nursery,FieldCode) %>% 
  drop_na(FieldCode)

# data <- data %>% left_join(nursery_data, by=c("FieldCode","PopulationCode","Family")) 
```

In the nursery dataset from @perryLongtermMultisiteScots2022, `r nrow(nursery_data)` trees have a field code. 

02/06/2023 - Annika found the field code of the trees that had none in @perryLongtermMultisiteScots2022, here is the updated file:

```{r LoadUpdatedNurseryData}
# Dataset updated by Annika - 02/06/2023
nursery_data <- read_excel(here("data/ScotsPine/SPnurseries_updatedByAnnika02062023.xlsx")) %>% 
  dplyr::rename(FieldCode=Tag)
```

We can then match the nursery and common garden data using the the field code:

```{r MergeNurseryData}
data <- data %>% left_join(nursery_data, by=c("FieldCode")) 
```

## Data formatting

We have to change the names of the block to specify that they are nested within sites:

```{r SiteSpecificBlocks}
# site-specific blocks
data <- data %>% mutate(Block = paste0(FieldSite,"_",Block))
```

According to @beatonPhenotypicTraitVariation2022, there are **four randomised blocks in both FS and FE** and **three in FW**. We look at the number of individuals in each block:

```{r NumberOfIndividualsPerBlock}
data %>% group_by(Block) %>% summarise("Number of individuals"=n()) %>% kable_mydf()
```

We see that there is one typo in FW (block noted as `c` instead of `C`), that we have to correct:

```{r COrrectTypoBlocks}
data <- data %>% mutate(Block=case_when(Block=="FW_c" ~ "FW_C",
                                TRUE ~ Block))

data %>% group_by(Block) %>% summarise("Number of individuals"=n()) %>% kable_mydf()
```

We save the dataset for further analyses.

```{r SaveData}
data %>% saveRDS(file=here("data/ScotsPine/formatted_CG_data.rds"))
```


# Phenotypic traits

Meaning of the phenotypic variables:

```{r TraitNames}
trait_names <- data %>% 
  dplyr::select(contains("HA"),contains("BD"),contains("BT")) %>% 
  colnames()

trait_names <- lapply(trait_names, function(x){
  
  if(grepl("HA",x)==TRUE){
    year <- str_sub(x,3,-1)
    trait_name <- paste0("Height in 20",year)
    list(code=x,name=trait_name)
  
    } else if(grepl("BD",x)==TRUE){
      year <- str_sub(x,3,-1)
      trait_name <- paste0("Duration of burburst in 20",year)
      list(code=x,name=trait_name)
      
    } else if(grepl("BT",x)==TRUE){
      year <- str_sub(x,3,-3)
      stage <- str_sub(x,6,-1)
      trait_name <- paste0("Time taken to reach stage ",stage," in 20", year)
      list(code=x,name= trait_name)
    }
}) %>% setNames(trait_names)

trait_names %>% 
  bind_rows() %>% 
  setNames(c("Variable code","Variable name")) %>% 
  kable_mydf()
```

## Measurements

We check whether each trait was measured in the three common gardens. 

```{r TraitMeasuredInEachCG}
traits <- data %>% 
  dplyr::select(contains("HA"),contains("BD"),contains("BT")) %>% 
  colnames()

lapply(traits, function(x) 
  data %>% 
    dplyr::select(FieldSite, any_of(x)) %>% 
    drop_na(any_of(x)) %>% 
    pull(FieldSite) %>% 
    unique()) %>% 
  setNames(traits)
```

Height in 2013 was not measured in FS, the field site in Yair (Scottish Borders).


## Trait distribution


```{r Histogram, fig.width=14,fig.height=14}
data %>% 
  dplyr::select(names(trait_names)) %>% 
  pivot_longer(everything(),names_to="variable",values_drop_na = TRUE) %>% 
  ggplot(aes(x=value)) +  
  geom_histogram(aes(y=after_stat(density)), colour="blue",fill="white",bins = 100) +
  geom_density(alpha=.2,fill="pink") +
  xlab("") +
  facet_wrap(~variable,scales="free") + 
  theme_bw() 
```

